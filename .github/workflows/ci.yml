name: CI

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        runs-on: ubuntu-latest
        env:
            POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'testuser' }}
            POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'testpass' }}
            POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'testdb' }}

        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_USER: ${{ env.POSTGRES_USER }}
                    POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
                    POSTGRES_DB: ${{ env.POSTGRES_DB }}
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"
                  cache: pip

            - name: Install dependencies
              run: pip install ".[test]"

            - name: Initialize database
              run: |
                  PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f init.sql

            - name: Run tests
              run: pytest -v
              env:
                  DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install ruff
              run: pip install ruff

            - name: Run linter
              run: ruff check . --output-format=github
